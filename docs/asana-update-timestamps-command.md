# Оновлення Timestamps Задач з Asana

## Опис

Консольна команда `asana:update-timestamps` оновлює поля `created_at` і `updated_at` задач у локальній базі даних з даними з Asana API.

## Використання

### Базове використання

```bash
php artisan asana:update-timestamps
```

За замовчуванням команда оновлює до 100 задач, у яких `created_at` дорівнює `updated_at` (що означає, що timestamps ще не були встановлені з Asana).

### Опції

#### `--task-id`

Оновити конкретну задачу за її ID в локальній базі даних.

```bash
php artisan asana:update-timestamps --task-id=376
```

#### `--limit`

Максимальна кількість задач для оновлення за один запуск (за замовчуванням: 100).

```bash
php artisan asana:update-timestamps --limit=500
```

#### `--force`

Оновити всі задачі з Asana GID, навіть якщо timestamps вже були встановлені.

```bash
php artisan asana:update-timestamps --force
```

### Комбіновані приклади

Оновити всі задачі з обмеженням 1000:

```bash
php artisan asana:update-timestamps --force --limit=1000
```

Оновити конкретну задачу з примусовим оновленням:

```bash
php artisan asana:update-timestamps --task-id=123 --force
```

## Що робить команда

1. **Вибирає задачі** для оновлення:
   - Якщо вказано `--task-id`, обробляється лише ця задача
   - Без `--force`: вибирає задачі, де `created_at` = `updated_at`
   - З `--force`: вибирає всі задачі з Asana GID

2. **Отримує дані з Asana API**:
   - Для кожної задачі викликає `AsanaService::getTaskDetails()`
   - Отримує `created_at` та `modified_at` з Asana

3. **Конвертує формат дат**:
   - Перетворює ISO 8601 формат (`2022-07-27T11:38:56.498Z`) 
   - У формат MySQL (`2022-07-27 11:38:56`)

4. **Оновлює базу даних**:
   - Використовує `DB::table()` для прямого оновлення
   - Обходить автоматичне оновлення timestamps Laravel
   - Зберігає точні дати з Asana

5. **Логує результати**:
   - Успішні оновлення записуються в лог
   - Помилки також записуються з деталями

## Вивід команди

Команда показує:
- 🕐 Початок роботи
- 📅 Режим роботи (нормальний або force)
- 📦 Кількість знайдених задач
- Прогрес-бар обробки
- ✅ Кількість оновлених задач
- ⚠️ Кількість пропущених задач (без даних)
- ❌ Кількість помилок
- 🎉 Завершення роботи

## Приклад виводу

```
🕐 Запуск оновлення часових міток задач з Asana...
📅 Оновлюємо задачі, де timestamps не встановлено з Asana
📦 Знайдено задач для оновлення: 50
 50/50 [============================] 100%

✅ Оновлено: 48
⚠️ Пропущено (немає даних): 2

🎉 Оновлення завершено!
```

## Коли використовувати

### Початкова синхронізація

Після імпорту задач з Asana, коли потрібно встановити правильні дати створення та модифікації:

```bash
php artisan asana:update-timestamps --force --limit=1000
```

### Регулярне оновлення

Для оновлення задач, які були створені/оновлені, але ще не мають правильних timestamps:

```bash
php artisan asana:update-timestamps --limit=100
```

### Виправлення конкретної задачі

Якщо потрібно виправити timestamps для конкретної задачі:

```bash
php artisan asana:update-timestamps --task-id=376
```

### Масове оновлення

Для оновлення всіх задач (наприклад, після міграції):

```bash
php artisan asana:update-timestamps --force --limit=5000
```

## Логування

Команда записує детальні логи в `storage/logs/laravel.log`:

### Успішне оновлення

```
[2025-10-28] local.INFO: Оновлено timestamps задачі
{
    "task_id": 376,
    "task_gid": "1202674268244540",
    "created_at": "2022-07-27 11:38:56",
    "updated_at": "2022-08-14 09:39:24"
}
```

### Помилка оновлення

```
[2025-10-28] local.ERROR: Помилка оновлення timestamps задачі
{
    "task_id": 376,
    "task_gid": "1202674268244540",
    "error": "Asana API connection failed"
}
```

## Технічні деталі

### Формат дат

**Asana API повертає** (ISO 8601 з мілісекундами і таймзоною):
```
2022-07-27T11:38:56.498Z
```

**Конвертується в MySQL формат**:
```
2022-07-27 11:38:56
```

### Прямий UPDATE

Команда використовує `DB::table()->update()` замість `Model::update()`, щоб:
- Обійти автоматичне оновлення `updated_at` Laravel
- Зберегти точні дати з Asana
- Підвищити продуктивність для масових оновлень

### Обробка помилок

- API помилки логуються і не зупиняють обробку інших задач
- Задачі без дат в Asana пропускаються
- Неіснуючі задачі повертають помилку

## Планування

Можна додати команду в планувальник для регулярного оновлення:

```php
// app/Console/Kernel.php або routes/console.php

Schedule::command('asana:update-timestamps --limit=50')
    ->daily()
    ->at('03:00');
```

## Зв'язок з іншими командами

Ця команда добре працює разом з:

- `asana:sync` - спочатку синхронізувати задачі
- `asana:sync-tasks` - резервна синхронізація
- `asana:sync-custom-fields` - синхронізація кастомних полів

Рекомендований порядок:

```bash
# 1. Синхронізувати задачі з Asana
php artisan asana:sync

# 2. Оновити timestamps з правильними датами
php artisan asana:update-timestamps --force --limit=1000

# 3. Синхронізувати кастомні поля
php artisan asana:sync-custom-fields
```

## Продуктивність

- Обробка 100 задач: ~1-2 хвилини (залежить від API)
- Обробка 1000 задач: ~10-15 хвилин
- Рекомендується використовувати `--limit` для великих баз даних
- API rate limits Asana: 1500 запитів/хвилину

## Перевірка результатів

Після виконання команди можна перевірити результати:

```bash
# Перевірити кількість задач з різними timestamps
php artisan tinker --execute="
echo 'Задач з різними timestamps: ' . 
\App\Models\Task::whereNotNull('gid')->whereRaw('created_at != updated_at')->count() . PHP_EOL;
"

# Перевірити конкретну задачу
php artisan tinker --execute="
\$task = \App\Models\Task::find(376);
echo 'Created: ' . \$task->created_at . PHP_EOL;
echo 'Updated: ' . \$task->updated_at . PHP_EOL;
"
```

