# Виправлення дублікатів при імпорті CSV

## Проблема
При імпорті CSV файлу створювалися дублікати записів, навіть якщо вони вже існували в базі даних.

### Причина
Перевірка на існування запису використовувала неправильне поле для порівняння:

**Було (неправильно):**
```php
$exists = ActOfWork::where('type', ActOfWork::TYPE_RECEIPT_OF_FUNDS)
    ->where('number', $documentNumber)
    ->where('date', $operationDate->format('Y-m-d'))
    ->where('total_amount', $amount)  // ❌ Помилка: порівняння з total_amount
    ->exists();
```

**Проблеми:**
1. Поле `total_amount` було встановлене як `0.00` при створенні запису
2. Порівняння йшло з `$amount`, який не дорівнював `0.00`
3. Метод `where('date', ...)` очікує точне співпадіння, а не тільки дати

## Рішення

### 1. Змінено перевірку на існування
```php
$exists = ActOfWork::where('type', ActOfWork::TYPE_RECEIPT_OF_FUNDS)
    ->where('number', $documentNumber)
    ->whereDate('date', $operationDate->format('Y-m-d'))  // ✅ Використовуємо whereDate
    ->where('paid_amount', $amount)                        // ✅ Порівняння з paid_amount
    ->exists();
```

**Зміни:**
- Використовується `whereDate()` замість `where()` для порівняння тільки дати (без часу)
- Порівняння відбувається з `paid_amount` замість `total_amount`

### 2. Виправлено збереження суми
```php
'total_amount' => $amount,  // ✅ Тепер зберігається правильна сума
'paid_amount' => $amount,
```

**Було:**
```php
'total_amount' => 0.00,     // ❌ Завжди нуль
'paid_amount' => $amount,
```

## Результат
Тепер при повторному імпорті того самого CSV файлу:
- ✅ Дублікати не створюються
- ✅ Існуючі записи коректно визначаються
- ✅ З'являється попередження: "Запис вже існує: документ {номер} від {дата} на суму {сума}"

## Перевірка на дублікати

Система перевіряє унікальність по чотирьом полям:
1. **type** - тип запису (надходження коштів)
2. **number** - номер документа
3. **date** - дата операції (тільки дата, без часу)
4. **paid_amount** - сума операції

Якщо всі чотири поля співпадають - запис вважається дублікатом і пропускається.

## Тестування
Для перевірки роботи виявлення дублікатів можна використати тестовий скрипт:

```bash
php test-import-duplicates.php
```

Скрипт виконує:
1. Підраховує записи до імпорту
2. Виконує перший імпорт
3. Виконує другий імпорт того самого файлу
4. Перевіряє, чи створилися дублікати

**Очікуваний результат:**
- При першому імпорті: додаються нові записи
- При другому імпорті: всі записи пропускаються як дублікати
- Кількість записів після другого імпорту = кількість після першого

## Приклад повідомлення про дублікат
```
⚠️ Запис вже існує: документ 297 від 15.10.2025 на суму 20000
```

## Поля для перевірки унікальності

| Поле | Опис | Приклад |
|------|------|---------|
| type | Тип запису | `receipt_of_funds` |
| number | Номер документа | `297` |
| date | Дата операції | `2025-10-15` |
| paid_amount | Сума надходження | `20000.00` |

## Додаткові покращення
- Використання `whereDate()` дозволяє порівнювати тільки дату, ігноруючи час
- Збереження правильної суми в обидва поля (`total_amount` та `paid_amount`)
- Чіткі повідомлення про виявлені дублікати

